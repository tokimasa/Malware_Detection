# -*- coding: utf-8 -*-
"""
Created on Mon Mar 12 19:12:16 2018

@author: TOKIMASA
"""

import pandas as pd
import datetime

def daterange(d1, d2):
    return (d1 + datetime.timedelta(days=i) for i in range((d2 - d1).days + 1))

date1 = datetime.date(2017, 3, 1)
#date2 = datetime.date(2017, 5, 31)
date2 = datetime.date(2017, 3, 1)
feature_df = pd.DataFrame()
for d in daterange(date1, date2):
    temp_df = pd.read_csv(str(d.strftime('%m%d')) + '.csv', names=['FileID', 'CustomerID', 'QueryTS', 'ProductID'], header=None)
    feature_df = feature_df.append(temp_df)

feature_df['QueryTS'] = feature_df['QueryTS'].apply(lambda x: datetime.datetime.fromtimestamp(x))
feature_df['QueryTS'] = feature_df['QueryTS'].apply(lambda x: datetime.datetime.strftime(x, '%H'))
feature_df['Day_Night'] = feature_df['QueryTS'].apply(lambda x: 0 if (int(x) >= 6 and int(x) < 18) else 1)

dataset_df = pd.DataFrame(feature_df.FileID.unique(),columns=['FileID'])

dataset_df = dataset_df.merge(pd.DataFrame(feature_df.groupby('FileID').CustomerID.nunique()).reset_index().rename(columns={'CustomerID':'Customer_Count'}), on='FileID', how='left')
dataset_df = dataset_df.merge(pd.DataFrame(feature_df.groupby(['FileID','CustomerID']).size().reset_index().groupby('FileID')[0].max(),columns=['Max_Customer_Repeat']).reset_index(), on='FileID', how='left')
dataset_df = dataset_df.merge(pd.DataFrame(feature_df.groupby('FileID').Day_Night.agg(['sum', 'count'])).reset_index(), on='FileID', how='left')
dataset_df = dataset_df.merge(pd.DataFrame(feature_df.groupby('FileID').ProductID.nunique()).reset_index().rename(columns={'ProductID':'Product_Count'}), on='FileID', how='left')
dataset_df = dataset_df.merge(pd.DataFrame(feature_df.groupby(['FileID','ProductID']).size().reset_index().groupby('FileID')[0].max(),columns=['Max_Product_Repeat']).reset_index(), on='FileID', how='left')

dataset_df['Night_Ratio'] = dataset_df['sum'] / dataset_df['count']

dataset_df = dataset_df[['FileID','Customer_Count','Max_Customer_Repeat','Product_Count','Max_Product_Repeat','Night_Ratio']]

dataset_df.to_csv('dataset.csv')
